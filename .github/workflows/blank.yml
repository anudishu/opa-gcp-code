name: Terraform OPA CI

on:
  push:
    branches:
      - master  # or main

jobs:
  terraform-opa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Google credentials
        run: |
          echo "${{ secrets.SA }}" > "${HOME}/gcp-key.json"
        shell: bash

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Install OPA and jq
        run: |
          sudo wget -O /usr/local/bin/opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          sudo chmod +x /usr/local/bin/opa
          sudo apt-get update && sudo apt-get install -y jq

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Generate JSON plan
        run: terraform show -json tfplan > tfplan.json

      - name: OPA Policy Check
        id: opa_check
        run: |
          result=$(opa eval -d policy.rego -i tfplan.json "data.terraform.gcp.deny" | jq -r '.result[0].expressions[0].value | @json')
          if [ "$result" != "[]" ] && [ "$result" != "null" ]; then
            echo "OPA Policy Violations Detected:"
            echo "$result"
            exit 1
          fi

      - name: Terraform Apply
        if: steps.opa_check.outcome == 'success'
        run: terraform apply -auto-approve tfplan